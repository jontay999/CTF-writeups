# VSCTF 2022 – Crypto Challenge

## Strongest RSA (53 solves): 464 points

### Description/Source

```python
from Crypto.Util.number import getStrongPrime, bytes_to_long
from sympy import prevprime, factorial
from math import gcd
import random

from secret import FLAG

e = 0x10001

def getStrongestPrime(nbits):
    while True:
        p = getStrongPrime(nbits)
        delta = random.randint(0x1337, 0x1337 + 0x1337)
        pp = p - delta
        ppp = prevprime(factorial(pp) % p)
        if gcd(ppp-1, e) == 1:
            return p, ppp

NBITS = 1024
p0, p = getStrongestPrime(NBITS)
q0, q = getStrongestPrime(NBITS)
N = p * q
m = bytes_to_long(FLAG.encode())
c = pow(m, e, N)

print(f"p0 = {p0}\nq0 = {q0}")
print(f"N = {N}\ne = {e}\nc = {c}")
```

There's an interesting way of generating primes. The hard part is that calculating $p_0!$ and $q_0!$ will take forever if we don't try to do it more efficiently. However we can apply Wilson's theorem in this case.

$$
(n-1)! ≡  -1\ \ (mod \ n)
$$

So if we have $p_0$, we have the equation that

$$
(p_0-1)! ≡  -1\ \ (mod \ p_0)
$$

And we have that

$$
4919 <= p0 - p <= 9838
$$

So there aren't that many answers for us to check, we can just keep multiplying $-1$ by the inverse mod of $(p_0-i)\  \% \ p_0$, until we find a factor of the modulus

### Solver

```python
from libnum import n2s
from tqdm import *
from sympy import prevprime

p0 = 163753477176210014003355280732229891908166074468271556144642666169325605017666799921295576722168608401188682320182653287668989748162506955989407213845500704903463544753049275828138559289189335596749709834289278256382427251831790026921563375111737350084174473833546767952081017613072491759534988253353621530923
q0 = 157598184809589313845990455272198459548591786211953253450211152128535343234857067521711590445365424087430728267491317690639227988484930088637483194045435135802590588269993794073236513557034321374876808546159597997280236993358749182432517011554239468502233558179815446959403076134284375214662245037202945590183
N = 11884142558095727641000594156833818117849240126500615037738361957005811068956622520280143210434649198031005585252791693777710458190732464123269660559382653636999601459113099276826723072914352276709761755328542359490331355061792823458149611674845846523699218971126655186522340818792078719216860046464292413878045842425132308544311887062610272360069819975798905665533964761527225558339025724872067751916657135473510775709503714808686565298632040214249698116863336246844759838665285888816202570667521796553678688293761589082062045634768520102235077364345013564344229095323239077977717497503322831684471959195555281580807
e = 65537
c = 11776079752956619284016871274992903352398310565005810097721997339193718454945819135683541554652454321040530044545154341786048659896370226535387839157317585368391189570502841702311449000698372030666509296004039398083488490698999338894328619127149024309470011330855840757405205104944658961386764569043610715311746676861275270073394069269043429092551681704290340091149637137627751767730812255069347108706434972786681985484368054390699974613090342753508097177008167140924577095976699437810398922852319420301082587264411993737330188227703869101718515748828944300463051133118636928879090217708121368293440440444106196607645

def getPrime():
    # (p-1)! % p == -1
    p_start = -1
    for i in trange(1,0x1337):
        p_start *= (pow(p0-i,-1,p0))
        p_start %= p0

    for i in trange(0x1337,0x1337*2+1):
        p_start *= (pow(p0-i,-1,p0))
        p_start %= p0
        possible = prevprime(p_start)
        if N % possible == 0:
            print("Found prime:", possible)
            break


p = 121251569719055184654500283184921633734825147878318860205149829847853476408734746401653435888068245285417688588619017109346386804108379667144354548976501625819408830758714481163514633291921705869166631936300840485837879550024821693541678242475439208966079871515312181522647811098976443583192246517917861929649
q = N//p
assert p*q == N
d = pow(e,-1,(p-1)*(q-1))
pt = pow(c,d,N)
print(n2s(pt))

```

### Flag

```
vsctf{Strongest_can_be_the_weakest:(}
```
